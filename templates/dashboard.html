{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block nav_buttons %}
<button id="dashboard_add" onclick="openDashboardModal()" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">+ Add</button>
<button id="dashboard_edit" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600">Edit</button>
<button id="dashboard_save" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 hidden">Save Layout</button>
{% endblock %}

{% block content %}
<h1 class="text-3xl font-bold mb-4">Dashboard</h1>
<p class="text-gray-600">This page is under construction.</p>

<div id="dashboard-grid"
     class="relative w-full grid"
     style="grid-template-columns: repeat(20, 1fr); grid-auto-rows: 1em;">
  {% set default_width = { 'value': 4, 'table': 10, 'chart': 10 } %}
  {% set default_height = { 'value': 3, 'table': 8,  'chart': 8 } %}
  {% set widget_layout = {} %}
  {% for widget in widgets %}
    {% set col_start = widget.col_start or 1 %}
    {% set col_span  = widget.col_span  or default_width[widget.widget_type] %}
    {% set row_start = widget.row_start or 1 %}
    {% set row_span  = widget.row_span  or default_height[widget.widget_type] %}
    {% set _ = widget_layout.update({ widget.id: {
      'colStart': col_start,
      'colSpan': col_span,
      'rowStart': row_start,
      'rowSpan': row_span
    } }) %}
    <div class="dashboard-widget draggable-field border p-2 rounded shadow bg-gray-50"
         data-widget="{{ widget.id }}"
         data-type="{{ widget.widget_type }}"
         {% if widget.widget_type == 'chart' %}data-config='{{ widget.content }}'{% endif %}
         style="grid-column: {{ col_start }} / span {{ col_span }}; grid-row: {{ row_start }} / span {{ row_span }};">
      {% if widget.widget_type == 'value' %}
        <div class="font-semibold">{{ widget.title }}</div>
        <div>{{ widget.content }}</div>
      {% elif widget.widget_type == 'chart' %}
        <div class="font-semibold mb-2">{{ widget.title }}</div>
        <canvas></canvas>
      {% else %}
        <div class="text-gray-500">{{ widget.widget_type }} widget</div>
      {% endif %}
      <span class="resize-handle hidden top-left"
            style="position:absolute; top:0; left:0; width:8px; height:8px; background:#333; cursor:nwse-resize; "></span>
      <span class="resize-handle hidden top-right"
            style="position:absolute; top:0; right:0; width:8px; height:8px; background:#333; cursor:nwse-resize; "></span>
      <span class="resize-handle hidden bottom-left"
            style="position:absolute; bottom:0; left:0; width:8px; height:8px; background:#333; cursor:nwse-resize; "></span>
      <span class="resize-handle hidden bottom-right"
            style="position:absolute; bottom:0; right:0; width:8px; height:8px; background:#333; cursor:nwse-resize; "></span>
    </div>
  {% endfor %}
</div>

{% include "dashboard_modal.html" %}

<script>const FIELD_SCHEMA = {{ field_schema | tojson }};</script>
<script>window.WIDGET_LAYOUT = {{ widget_layout | tojson }};</script>
<script type="module" src="{{ url_for('static', filename='js/dashboard_modal.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/dashboard_grid.js') }}"></script>
<script type="module" src="{{ url_for('static', filename='js/dashboard_charts.js') }}"></script>
{% endblock %}
