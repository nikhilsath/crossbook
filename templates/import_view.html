{% extends "base.html" %}
{% block title %}Import Records{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">
  <h1 class="text-3xl font-bold mb-6">Import CSV</h1>

  <div class="mb-6">
    <div class="flex items-center space-x-4">
      <form method="GET" action="/import" class="flex items-center space-x-2">
        <label for="table" class="font-medium mr-2">Select Base Table</label>
        <select name="table" id="table" class="border rounded px-3 py-2" onchange="this.form.submit()">
          <option value="" disabled {% if not selected_table %}selected{% endif %}>Choose a table</option>
          {% for table in schema.keys() %}
            <option value="{{ table }}" {% if selected_table == table %}selected{% endif %}>{{ table|capitalize }}</option>
          {% endfor %}
        </select>
      </form>

      {% if selected_table %}
      <form method="POST" action="/import" enctype="multipart/form-data" class="flex items-center space-x-2">
        <input type="hidden" name="table" value="{{ selected_table }}">
        <input type="file" name="file" accept=".csv" class="border rounded px-3 py-2">
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">Upload</button>
      </form>
      {% endif %}

      {% if num_records is defined %}
      <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded whitespace-nowrap">
        Total Records: {{ num_records if num_records is not none else 'None' }}
      </div>
      {% endif %}
    </div>
  </div>

  {% if selected_table %}
  <div class="flex flex-row space-x-4">
    <div class="md:w-1/2">
        <h2 class="text-xl font-semibold mb-2">Available Fields for Imported File</h2>
        <div class="grid grid-cols-1 gap-2 text-sm text-gray-700" id="imported-fields-container">
            {% for header in parsed_headers %}
            <div class="border px-3 py-2 rounded bg-gray-50" id="match-container-{{ header }}">
              <div class="flex justify-between items-center">
                <strong>{{ header }}</strong>
                <div id="select-wrapper-{{ header }}" class="ml-auto">
                  <select name="match_{{ header }}" data-header="{{ header }}" class="border rounded px-2 py-1 text-sm" onchange="handleDropdownChange(event, '{{ header }}')">
                    <option value="">Unmatched</option>
                    {% for field, data in field_status.items() %}
                      {% if not data.matched %}
                        <option value="{{ field }}">{{ field }} — {{ data.type }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>
              {% if validation_report and header in validation_report %}
              <div class="text-xs mt-1 space-x-2">
                <span class="text-green-600">✅ {{ validation_report[header].valid }} valid</span>
                <span class="text-yellow-600">⚠️ {{ validation_report[header].warning }} warnings</span>
                <span class="text-red-600">❌ {{ validation_report[header].invalid }} invalid</span>
                <span class="text-black">⬛ {{ validation_report[header].blank }} blank</span>
              </div>
              {% endif %}
            </div>
          {% endfor %}          
        </div>
    </div>
    <div class="md:w-1/2">
      <h2 class="text-xl font-semibold mb-2">Available Fields for '{{ selected_table }}'</h2>
      <div class="grid grid-cols-1 gap-2 text-sm text-gray-700" id="available-fields-list">
        {% for field, data in field_status.items() %}
        <div class="border px-3 py-2 rounded bg-gray-50">
            <strong>{{ field }}</strong> — {{ data.type }} — matched: {{ data.matched }}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <template id="dropdown-template">
    <select name="match___HEADER__" data-header="__HEADER__" class="border rounded px-2 py-1 text-sm" onchange="handleDropdownChange(event, '__HEADER__')">
      <option value="">Unmatched</option>
      {% for field, data in field_status.items() %}
        {% if not data.matched %}
          <option value="{{ field }}">{{ field }} — {{ data.type }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </template>
</div>
<script>
  const fieldSchema = {{ field_status|tojson }};
</script>
<script src="/static/imports/match_logic.js"></script>
{% endblock %}
